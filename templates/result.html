<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{{ info }}</title>

	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/table.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/form.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/connection.css') }}">
	<link rel="icon" href="{{url_for('static', filename='icons/icon_144.png')}}" type="image/png">
	<link rel="icon" href="{{url_for('static', filename='icons/icon_192.png')}}" type="image/png">
	<link rel="icon" href="{{url_for('static', filename='icons/icon_512.png')}}" type="image/png">
	<link rel="apple-touch-icon" sizes="144x144" href="{{url_for('static', filename='icons/icon_144.png')}}" type="image/png">
	<link rel="apple-touch-icon" sizes="192x192" href="{{url_for('static', filename='icons/icon_192.png')}}" type="image/png">
	<link rel="apple-touch-icon" sizes="512x512" href="{{url_for('static', filename='icons/icon_512.png')}}" type="image/png">
	<link rel="manifest" href="/manifest.json">

  <script src="https://kit.fontawesome.com/4c8fc690ad.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>


</head>
<body>
  <div class="view info_title">
    <h1>{{ info }}</h1>
    <h1 id="sum">Sum: 0</h1>

    <form method="get" action="./get_CSV">
      <input type="submit" value="Download logs">
    </form>
  </div>

  <table align="center" id="logTable">
    <thead>
      <tr>
        <th>Amount</th>
        <th>Description</th>
        <th>Category</th>
        <th>Datetime</th>
      </tr>
    </thead>
    <tbody>
      <!-- Data will be populated here by JavaScript -->
    </tbody>
  </table>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      fetch('./get_log')
        .then(response => response.json())
        .then(data => {
          document.getElementById('sum').textContent = "Sum: " + data.sum;
          const logTableBody = document.getElementById('logTable').getElementsByTagName('tbody')[0];
          data.log.forEach(entry => {
            let row = logTableBody.insertRow();
            let amountCell = row.insertCell(0);
            let descCell = row.insertCell(1);
            let categoryCell = row.insertCell(2);
            let datetimeCell = row.insertCell(3);
            amountCell.textContent = entry.amount;
            descCell.textContent = entry.description;
            categoryCell.textContent = entry.category;
            datetimeCell.textContent = formatDatetime(entry.datetime);
          });
        })
        .catch(error => console.error('Error fetching log data:', error));
    });

    function formatDatetime(datetime) {
      const now = moment();
      const entryTime = moment(datetime);
      const diffMinutes = now.diff(entryTime, 'minutes');
      const diffHours = now.diff(entryTime, 'hours');
      const diffDays = now.diff(entryTime, 'days');

      if (diffMinutes < 5) {
        return 'Just now';
      } else if (diffMinutes < 60) {
        return `${diffMinutes} minutes ago`;
      } else if (diffHours < 24) {
        return `${diffHours} hours ago`;
      } else if (diffDays < 7) {
        const dayOfWeek = entryTime.format('dddd');
        const period = getTimePeriod(entryTime.hour());
        return `${dayOfWeek} ${period}`;
      } else {
        const date = entryTime.format('MM/DD');
        const period = getTimePeriod(entryTime.hour());
        return `${date} ${period}`;
      }
    }

    function getTimePeriod(hour) {
      if (hour >= 0 && hour < 5) {
        return 'early morning';
      } else if (hour >= 5 && hour < 11) {
        return 'morning';
      } else if (hour >= 11 && hour < 14) {
        return 'noon';
      } else if (hour >= 14 && hour < 17) {
        return 'afternoon';
      } else {
        return 'evening';
      }
    }
  </script>
  
</body>
</html>
